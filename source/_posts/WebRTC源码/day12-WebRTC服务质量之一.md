---

title: day12-WebRTC服务质量之一
categories:
  - WebRTC源码
tags:
  - WebRTC
date: 2022-09-11 20:41:31
---

## 一、认识RTP、RTCP

### 1、章节概述，对day12的知识要点概述

> 本章节的内容，都是WebRTC的精华，也是面试最高频的问题。建议反复观看，优先消化理解。



![image-20220911155051371](day12-WebRTC服务质量之一/image-20220911155051371.png)

![image-20220911155058428](day12-WebRTC服务质量之一/image-20220911155058428.png)

### 2、你更愿意是线上听课，还是线下听课？试试通信的目标是什么？

- 线上听课容易收到 `技术、设备、网络` 等影响，其实效果远远没有线下好。
- 试试通信的目标：尽可能逼近或达到面对面交流的效果。

### 3、为了极可能达到面对面的交流效果，有哪几个重要指标？

- 实时通信的延迟指标
- 音频服务质量
- 视频服务质量

![image-20220911180433875](day12-WebRTC服务质量之一/image-20220911180433875.png)

![image-20220911180437659](day12-WebRTC服务质量之一/image-20220911180437659.png)

![image-20220911180441941](day12-WebRTC服务质量之一/image-20220911180441941.png)

![image-20220911180445689](day12-WebRTC服务质量之一/image-20220911180445689.png)



### 4、 `时延` 和 `音视频质量` 之间是否存在矛盾？矛盾的解决思路是什么？

![image-20220911180544206](day12-WebRTC服务质量之一/image-20220911180544206.png)

![image-20220911180548456](day12-WebRTC服务质量之一/image-20220911180548456.png)



### 4、RTP在网络协议的哪一层？

![image-20220911180624280](day12-WebRTC服务质量之一/image-20220911180624280.png)

![image-20220911180630597](day12-WebRTC服务质量之一/image-20220911180630597.png)

> RTP其实和UDP很相似，都是一个一个包传输的，但是UDP是无法保证包的顺序的，那么WebRTC是如何保证RTP的顺序呢？
>
> 每个包都有一个 `sequence number`，借助 `sequence number` 来保证每一个包在发送端和接收端的顺序。

### 6、认识RTP的头信息包含哪些？

- V：表示RTC协议的版本号，一般是2
- P：代表是否有填充数据
- X：代表RTP中是否有扩展头
- CC：Contribute Source，表示对于我们这个数据来说，它是由哪些源共同生成的。比如多人视频，声音是三个组合而成的CC就是3。
- M：代表视频帧分包之后的最后一个帧（标记位）
- PT：Payload Type，表示这个数据的负载类型是什么？比如音频opus是111、视频是127
- Sequence Number：主要是接收到视频数据之后，保证我们乱序的包能够进行排序。
- TimeStamp：表示我们这个包产生的时间戳。对于一个视频帧，可能被分成多个RTP包，但是这些所有的RTP包中TimeStamp都是相同的。随着时间的流逝，不同帧的timeStamp都是递增的。
- SSRC：用来区分不同的流，比PT更加准确。比如一个客户端同事共享了桌面视频流和摄像头视频流，这时候PT是相同的，我们就可以通过SSRC来进行区分了。
- CSRC：代表我们这个数据，是由几个贡献者共同共享的。



![image-20220911180831934](day12-WebRTC服务质量之一/image-20220911180831934.png)

![image-20220911181514023](day12-WebRTC服务质量之一/image-20220911181514023.png)

![image-20220911181517328](day12-WebRTC服务质量之一/image-20220911181517328.png)

### 7、WebRTC是如何对视频进行分包的？

![image-20220911181608752](day12-WebRTC服务质量之一/image-20220911181608752.png)

![image-20220911181611696](day12-WebRTC服务质量之一/image-20220911181611696.png)

- 对于一个视频帧，通常比较大，需要分成十几个包进行传输。
- 我们看到104包的M位是1，代表是一帧数据的结束位。所以从100~104包中，103包丢了。
- WebRTC会等待很小的一段时间，如果103来了，那么就会组成一个完整的视频帧；如果很小一段时间内，103还是未收到，那么WebRTC就会丢弃这一帧的数据，去组装下一帧的数据。



### 8、什么情况下代表RTP有扩展头数据？初识RTP扩展头里面有哪些信息？

- 如果RTP头的X位是1，那么代表这个RTP包有扩展头。

![image-20220911181934637](day12-WebRTC服务质量之一/image-20220911181934637.png)

![image-20220911181939521](day12-WebRTC服务质量之一/image-20220911181939521.png)

![image-20220911181943004](day12-WebRTC服务质量之一/image-20220911181943004.png)

### 9、详细讲解扩展头的每个字段含义？

![image-20220911182006353](day12-WebRTC服务质量之一/image-20220911182006353.png)

![image-20220911182011800](day12-WebRTC服务质量之一/image-20220911182011800.png)

![image-20220911182018005](day12-WebRTC服务质量之一/image-20220911182018005.png)

- length=3表示后面的扩展数据长度是 3*4=12字节
- 在①中 L=0 表示后面的数据data的长度是 (L+1) = 1字节
- 在②中 L=1 表示后面的数据data的长度是 (L+1) = 2字节
- 在③中 L=2 表示后面的数据data的长度是 (L+1) = 3字节，但是数据实际只有2个字节，所以用 `0(pad)`进行了填充

![image-20220911182038347](day12-WebRTC服务质量之一/image-20220911182038347.png)

- 两字节的扩展头里面的 `L=0` 含义是代表后面数据的实际长度，`L=0`就是后面无数据了。（注意和前面一字节的扩展头区分开来）



### 10、WebRTC用到的扩展头？

![image-20220911182058845](day12-WebRTC服务质量之一/image-20220911182058845.png)

- 每一个扩展项的说明，都在源码的注释里面有说明

![image-20220911182109957](day12-WebRTC服务质量之一/image-20220911182109957.png)

![image-20220911182113213](day12-WebRTC服务质量之一/image-20220911182113213.png)

- 【重要】但凡有一个看不懂，都可以倒回去看看 12-4 章节的内容，一定要熟知

### 11、RTCP的协议在网络协议的哪一层？与IP包、UDP包有什么关系？

![image-20220911182142750](day12-WebRTC服务质量之一/image-20220911182142750.png)

### 12、RTCP Header中包含哪些字段，分别是什么含义？



![image-20220911183139973](day12-WebRTC服务质量之一/image-20220911183139973.png)

- V：version，版本号
- P：是否有填充位，一般是因为字节对齐需要。
- Count：表示我们这个RTCP协议中包含的ReportBlock有多少个？
- Type：根据功能的不同，有不同的RTCP的Type
- Length：表示我们这个RTCP的数据有多长，数值为（N-1）个4字节

![image-20220911183348616](day12-WebRTC服务质量之一/image-20220911183348616.png)

![image-20220911183404924](day12-WebRTC服务质量之一/image-20220911183404924.png)

![image-20220911183410244](day12-WebRTC服务质量之一/image-20220911183410244.png)

### 13、重点认识 SR 这种RTCP包？

![image-20220911183437801](day12-WebRTC服务质量之一/image-20220911183437801.png)

![image-20220911183444662](day12-WebRTC服务质量之一/image-20220911183444662.png)

- NTP TImeStamp：是我们真实世界中的真实时间，通过这个时间我们做音视频同步，因为不同的源它们的NTP时间是一样的。
- RTP TimeStamp：它是一个相对时间，只针对我们这一路流起作用；当有多路流时，它们是相互没有关系的。

![image-20220911183502979](day12-WebRTC服务质量之一/image-20220911183502979.png)

![image-20220911183509230](day12-WebRTC服务质量之一/image-20220911183509230.png)

![image-20220911183514237](day12-WebRTC服务质量之一/image-20220911183514237.png)

### 13、重点认识RR这种RTCP包

![image-20220911183539397](day12-WebRTC服务质量之一/image-20220911183539397.png)

- RR的作用，就是为了告诉对方，我接收了多少包，丢了多少包；结构与SR类型类似。
- SR和RR重要的作用都是发送Report Block



### 14、重点认识RTCP中SDES格式是什么？在WebRTC中有什么作用？

![image-20220911183556020](day12-WebRTC服务质量之一/image-20220911183556020.png)

- SC：SDES Item Count，表示后面的SDES Items 的个数

![image-20220911183606833](day12-WebRTC服务质量之一/image-20220911183606833.png)

![image-20220911183610948](day12-WebRTC服务质量之一/image-20220911183610948.png)

![image-20220911183614316](day12-WebRTC服务质量之一/image-20220911183614316.png)

![image-20220911183618004](day12-WebRTC服务质量之一/image-20220911183618004.png)

- RTCP中SDES作用：主要就是为了确认CNAME和SSRC之间的关系，如果产生重复冲突，就能通过SDES重新建立CNAME和SSRC的关系。



### 14、其他类型的RTCP报文：BYE报文

![image-20220911183632892](day12-WebRTC服务质量之一/image-20220911183632892.png)

- BYE中可以指定接收端需要关闭那个SSRC中的流
- RTCP中的APP报文
- 如果我们需要自己实现对RTCP的控制时，就可以使用APP这个报文

![image-20220911183647134](day12-WebRTC服务质量之一/image-20220911183647134.png)

![image-20220911183650900](day12-WebRTC服务质量之一/image-20220911183650900.png)

### 16、RTPFB报文格式是什么？作用是什么?

![image-20220911183701739](day12-WebRTC服务质量之一/image-20220911183701739.png)

![image-20220911183705042](day12-WebRTC服务质量之一/image-20220911183705042.png)

![image-20220911183707690](day12-WebRTC服务质量之一/image-20220911183707690.png)

![image-20220911183711064](day12-WebRTC服务质量之一/image-20220911183711064.png)

- FMT：Feedback Message Type

![image-20220911183720256](day12-WebRTC服务质量之一/image-20220911183720256.png)



### 17、什么是Compound RTCP呢？

![image-20220911183728271](day12-WebRTC服务质量之一/image-20220911183728271.png)

![image-20220911183731464](day12-WebRTC服务质量之一/image-20220911183731464.png)

![image-20220911183736043](day12-WebRTC服务质量之一/image-20220911183736043.png)

![image-20220911183739983](day12-WebRTC服务质量之一/image-20220911183739983.png)

![image-20220911183743359](day12-WebRTC服务质量之一/image-20220911183743359.png)

- 上图的Compound RTCP都是由SR + SDES组成的

![image-20220911183754135](day12-WebRTC服务质量之一/image-20220911183754135.png)






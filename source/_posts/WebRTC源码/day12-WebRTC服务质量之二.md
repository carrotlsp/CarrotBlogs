---

title: day12-WebRTC服务质量之二
categories:
  - WebRTC源码
tags:
  - WebRTC
date: 2022-09-14 20:41:31
---

## 二、丢包相关的内容



### 1、NACK的作用是什么？RTX的作用是什么？

- NACK：用于通知丢了哪些包
- RTX：用于重传丢失的包

![image-20220912084401515](day12-WebRTC服务质量之二/image-20220912084401515.png)

![image-20220912084412966](day12-WebRTC服务质量之二/image-20220912084412966.png)

> 图中媒体协商阶段解读：这个视频媒体流使用的是VP8、可以使用NACK通知丢包、 96和97是关联关系、97是96的丢包重传流
>
> 【必须掌握】这图是纲领



### 2、WebRTC接收端如何判断是否发生了丢包？

- 通过对收到包进行重拍之后，发现Sequence number依然不连续，那就是发生了丢包

![image-20220912084829288](day12-WebRTC服务质量之二/image-20220912084829288.png)

### 3、WebRTC是如何给包做排序的？有一个关键函数是什么？



![image-20220912084905867](day12-WebRTC服务质量之二/image-20220912084905867.png)

![image-20220912084909034](day12-WebRTC服务质量之二/image-20220912084909034.png)

![image-20220912084912425](day12-WebRTC服务质量之二/image-20220912084912425.png)

- 关键点：理解AheadOf的函数名字的含义

### 4、NACK的调用栈？

- 从下往上阅读

![image-20220912084932932](day12-WebRTC服务质量之二/image-20220912084932932.png)



![image-20220912084943818](day12-WebRTC服务质量之二/image-20220912084943818.png)

![image-20220912084947525](day12-WebRTC服务质量之二/image-20220912084947525.png)

![image-20220912084950945](day12-WebRTC服务质量之二/image-20220912084950945.png)

### 4、NACK模块如何判断是否丢包的代码逻辑

![image-20220912085001851](day12-WebRTC服务质量之二/image-20220912085001851.png)

![image-20220912085004796](day12-WebRTC服务质量之二/image-20220912085004796.png)

![image-20220912085007507](day12-WebRTC服务质量之二/image-20220912085007507.png)

- keyframe_list只缓冲10000个包，超过之后，会把最老的那个删除掉

![image-20220912085017249](day12-WebRTC服务质量之二/image-20220912085017249.png)

- recovered_list只缓冲10000个包，超过之后，会把最老的那个删除掉

![image-20220912085025383](day12-WebRTC服务质量之二/image-20220912085025383.png)

- 上面是nack的最核心代码

![image-20220912085033777](day12-WebRTC服务质量之二/image-20220912085033777.png)

- nack_list只缓冲10000个包，超过之后，会把最老的那个删除掉

![image-20220912085045181](day12-WebRTC服务质量之二/image-20220912085045181.png)

### 6、【上面仅仅找到可疑的丢包】那么nack如何找到真正的丢包？

![image-20220912085056014](day12-WebRTC服务质量之二/image-20220912085056014.png)

![image-20220912085059585](day12-WebRTC服务质量之二/image-20220912085059585.png)

![image-20220912085103029](day12-WebRTC服务质量之二/image-20220912085103029.png)

![image-20220912085106602](day12-WebRTC服务质量之二/image-20220912085106602.png)

![image-20220912085111145](day12-WebRTC服务质量之二/image-20220912085111145.png)

- 关键点还是会等待一个RTT时间，防止丢失的包仅仅只是乱序导致的。

### 7、VP8是如何判断关键帧？

![image-20220912085204350](day12-WebRTC服务质量之二/image-20220912085204350.png)

![image-20220912085210056](day12-WebRTC服务质量之二/image-20220912085210056.png)

![image-20220912085216609](day12-WebRTC服务质量之二/image-20220912085216609.png)

【12-14】有对VP8 Payload描述符的详细解释，需要时回来取

![image-20220912085225085](day12-WebRTC服务质量之二/image-20220912085225085.png)

![image-20220912085229729](day12-WebRTC服务质量之二/image-20220912085229729.png)

![image-20220912085233509](day12-WebRTC服务质量之二/image-20220912085233509.png)

- 介绍完 VP8的Description，我们再看下VP8的 Payload Header

![image-20220912085243598](day12-WebRTC服务质量之二/image-20220912085243598.png)

![image-20220912085246848](day12-WebRTC服务质量之二/image-20220912085246848.png)

![image-20220912085250868](day12-WebRTC服务质量之二/image-20220912085250868.png)

![image-20220912085254255](day12-WebRTC服务质量之二/image-20220912085254255.png)

> 判断VP8的关键帧：每个RTP包中，描述符的（S位置1 && PID=0）这些包，拿到这些的Header中的（P位置为1）就是关键帧。

### 8、NACK的格式是怎么样的？

![image-20220912085312133](day12-WebRTC服务质量之二/image-20220912085312133.png)

![image-20220912085315909](day12-WebRTC服务质量之二/image-20220912085315909.png)

- 抓包查看NACK的包

![image-20220912085324459](day12-WebRTC服务质量之二/image-20220912085324459.png)

### 9、WebRTC接收Nack的调用栈是怎么样的？

![image-20220912085333151](day12-WebRTC服务质量之二/image-20220912085333151.png)

![image-20220912085336080](day12-WebRTC服务质量之二/image-20220912085336080.png)

![image-20220912085339993](day12-WebRTC服务质量之二/image-20220912085339993.png)

![image-20220912085344063](day12-WebRTC服务质量之二/image-20220912085344063.png)

![image-20220912085348012](day12-WebRTC服务质量之二/image-20220912085348012.png)

![image-20220912085351492](day12-WebRTC服务质量之二/image-20220912085351492.png)

![image-20220912085355793](day12-WebRTC服务质量之二/image-20220912085355793.png)

### 10、WebRTC的RTX协议格式是怎么样的？RTX的作用是什么？

![image-20220912085404325](day12-WebRTC服务质量之二/image-20220912085404325.png)

- 收到RTX包后，如何判断它重传的是哪个包？

![image-20220912085412776](day12-WebRTC服务质量之二/image-20220912085412776.png)

![image-20220912085416805](day12-WebRTC服务质量之二/image-20220912085416805.png)

- 我们实际操作一下，如何找到RTX包

![image-20220912085425244](day12-WebRTC服务质量之二/image-20220912085425244.png)

![image-20220912085429168](day12-WebRTC服务质量之二/image-20220912085429168.png)

- 从上图中，我们可以找到RTX包，也就是重传包
- 那么如何找到我们NACK包，然后让这两者对应起来呢？

![image-20220912085440032](day12-WebRTC服务质量之二/image-20220912085440032.png)

![image-20220912085445401](day12-WebRTC服务质量之二/image-20220912085445401.png)



### 11、WebRTC如何发送RTX包的呢？

![image-20220912085456772](day12-WebRTC服务质量之二/image-20220912085456772.png)

![image-20220912085500585](day12-WebRTC服务质量之二/image-20220912085500585.png)

![image-20220912085503923](day12-WebRTC服务质量之二/image-20220912085503923.png)

> 发送过程：WebRTC就是根据NACK从历史记录中找到对应的包，然后判断是否开启RTX功能，然后将丢失的包重新打包成RTX包，发送出去

![image-20220912085513779](day12-WebRTC服务质量之二/image-20220912085513779.png)

![image-20220912085516978](day12-WebRTC服务质量之二/image-20220912085516978.png)

![image-20220912085520076](day12-WebRTC服务质量之二/image-20220912085520076.png)


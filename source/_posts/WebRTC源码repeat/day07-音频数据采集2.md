---
title: day07-éŸ³é¢‘æ•°æ®é‡‡é›†2-ADMåˆ›å»ºè¿‡ç¨‹ã€æœ¬åœ°éŸ³é¢‘çš„é‡‡é›†&&åŠ å¯†å°è£…&&ä¼ è¾“
date: 2022-11-25 07:35:29
tags: 
	- WebRTC
categories: 
	- WebRTCæºç Repeat

---

### 1ã€ADMåœ¨iOSä¸Šåˆ›å»ºè¿‡ç¨‹ï¼Ÿ

```c++
- (instancetype)
    initWithEncoderFactory:(nullable id<RTC_OBJC_TYPE(RTCVideoEncoderFactory)>)encoderFactory
            decoderFactory:(nullable id<RTC_OBJC_TYPE(RTCVideoDecoderFactory)>)decoderFactory 
{
	è°ƒç”¨ [self audioDeviceModule].get() è·å–ADM
}

- (rtc::scoped_refptr<webrtc::AudioDeviceModule>)audioDeviceModule
{
	è°ƒç”¨ webrtc::CreateAudioDeviceModule() ç»§ç»­åˆ›å»ºADM
	å†é—´è·è°ƒç”¨ rtc::scoped_refptr<AudioDeviceModule> CreateAudioDeviceModule(bool bypass_voice_processing) ç»§ç»­åˆ›å»º
}

rtc::scoped_refptr<AudioDeviceModule> CreateAudioDeviceModule(bool bypass_voice_processing) 
{
	è°ƒç”¨ rtc::make_ref_counted<ios_adm::AudioDeviceModuleIOS>(bypass_voice_processing) æœ€ç»ˆåˆ›å»ºäº†å‡ºäº†ADMæ˜¯AudioDeviceModuleIOSç±»å‹
}
```



### 2ã€éŸ³é¢‘ç±»æŒæœ‰å…³ç³»ï¼Ÿ

```c++
PeerConnectionFactory -> æŒæœ‰ ğŸ‘‡ğŸ»

PeerConnectionFactoryDependenciesï¼ˆdependenciesï¼‰-> æŒæœ‰ ğŸ‘‡ğŸ»

CompositeMediaEngine ï¼ˆmedia_engineï¼‰-> æŒæœ‰ ğŸ‘‡ğŸ»

WebRtcVoiceEngineï¼ˆaudio_engineï¼‰-> æŒæœ‰ ğŸ‘‡ğŸ»

MediaEngineDependencies -> æŒæœ‰ ğŸ‘‡ğŸ»

AudioDeviceModuleï¼ˆadmï¼‰-> æŒæœ‰ ğŸ‘‡ğŸ» -> è¿˜æŒæœ‰ AudioDeviceBuffer

AudioDeviceIOSï¼ˆaudio_device_ï¼‰-> æŒæœ‰ ğŸ‘‡ğŸ»  -> è¿˜æŒæœ‰ AudioDeviceBuffer

VoiceProcessingAudioUnitï¼ˆaudio_unit_ï¼‰
è¿™ä¸ªç±»æ‰æ˜¯çœŸæ­£ç”¨äºéŸ³é¢‘çš„å½•åˆ¶ä¸æ’­æ”¾çš„
```



### 3ã€kInputBus ==1å’Œ kInputBus ==0åˆ†åˆ«ä»£è¡¨ä»€ä¹ˆï¼Ÿ

```c++
å…³é”®çŸ¥è¯†ç‚¹ ğŸ‘‡ğŸ»â€¨
// A VP I/O unit's bus 1 connects to input hardware (microphone).
static const AudioUnitElement kInputBus = 1;
// A VP I/O unit's bus 0 connects to output hardware (speaker).
static const AudioUnitElement kOutputBus = 0;
```



### 4ã€æœ¬åœ°éŸ³é¢‘æµè½¬çº¿è·¯ï¼ˆä¿å­˜ï¼‰<font color="red">ã€importantã€‘</font>ï¼Ÿ

```c
AudioDeviceIOS::OnDeliverRecordedData ï¼ˆä»ä¸Šé¢çš„audio_unit_å›è°ƒçš„æ•°æ®ï¼‰
{
	è°ƒç”¨ audio_unit_->Render() å‡½æ•°ï¼Œå¯¹éŸ³é¢‘æ•°æ®è¿›è¡Œè·å–
	è°ƒç”¨ fine_audio_buffer_->DeliverRecordedData() å‡½æ•°ï¼Œå¯¹éŸ³é¢‘æ•°æ®è½¬æ¢æˆWebrtcçš„bufferã€‚
}


void FineAudioBuffer::DeliverRecordedData  
{
	å°†éŸ³é¢‘10æ¯«ç§’è¿›è¡Œåˆ†å‰²
	å°†å¤„ç†å¥½çš„éŸ³é¢‘æ”¾å…¥ audio_device_buffer_->SetVQEData ä¸­
	ç„¶åè°ƒç”¨ AudioDeviceBuffer::DeliverRecordedData è¿›è¡Œä¸‹ä¸€æ­¥çš„å¤„ç†
}

int32_t AudioDeviceBuffer::DeliverRecordedData
{
	è°ƒç”¨ audio_transport_cb_->RecordedDataIsAvailable ç»§ç»­å¤„ç†æ•°æ®
}


int32_t AudioTransportImpl::RecordedDataIsAvailable
{
	å¯¹éŸ³é¢‘æ•°æ®å°è£…æˆ AudioFrame
	å¯¹éŸ³é¢‘æ•°æ®é‡é‡‡æ ·å’Œæ··éŸ³ voe::RemixAndResample
	å¯¹éŸ³é¢‘ä½¿ç”¨åº”ç”¨å±‚ç®—æ³• ProcessCaptureFrame
	è°ƒç”¨ SendProcessedData å°† AudioFrame å‘å‡ºå»
}


void AudioTransportImpl::SendProcessedData 
{
	éå†æ‰€æœ‰çš„éŸ³é¢‘å‘é€å™¨ï¼ˆaudio_senders_ã€AudioSenderï¼‰
	æ¯ä¸ªéŸ³é¢‘å‘é€å™¨å‘é€ä¸€é AudioFrame
	æœ€åï¼ŒåŸå§‹çš„ audio_frame è¢«å‘é€ç»™ç¬¬ä¸€ä¸ªéŸ³é¢‘å‘é€å™¨ï¼Œé¿å…é¢å¤–çš„æ•°æ®å¤åˆ¶ã€‚
}

void AudioSendStream::SendAudioData
{
	è°ƒç”¨ channel_send_->ProcessAndEncodeAudio å°†æ•°æ®è¿›è¡Œå‘é€
}


void ChannelSend::ProcessAndEncodeAudio
{
	å°†éŸ³é¢‘æ”¾å…¥ encoder_queue_ (rtc::TaskQueue) é˜Ÿåˆ—ç­‰å¾…å¤„ç†
	é˜Ÿåˆ—æ‰§è¡Œæ—¶ï¼Œè°ƒç”¨audio_coding_ï¼ˆAudioCodingModule::Add10MsDataï¼‰
}

int AudioCodingModuleImpl::Add10MsData 
{
	Add10MsDataInternal å¯¹éŸ³é¢‘çš„é‡‡æ ·ç‡ã€å£°é“æ•°ã€é•¿åº¦åšå‡ºåˆ¤æ–­ï¼Œå¦‚æœæ•°æ®ä¸åˆè§„ï¼Œå°±æŠ›å¼ƒæ‰
	Add10MsDataInternal è°ƒç”¨ AudioCodingModuleImpl::PreprocessToAddData å¯¹éŸ³é¢‘è¿›è¡Œæ£€æŸ¥ï¼Œå¦‚æœé‡‡æ ·ç‡ã€å£°é“æ•°ã€æ··éŸ³ä¸ç¬¦åˆè¦æ±‚ï¼Œä¼šè¿›è¡Œé‡é‡‡æ ·
	æœ€åè°ƒç”¨ Encode å¯¹éŸ³é¢‘è¿›è¡Œå¤„ç†ï¼Œè¿™æ®µä»£ç æ˜¯éŸ³é¢‘ç¼–ç çš„æ ¸å¿ƒéƒ¨åˆ†ï¼Œå°†éŸ³é¢‘æ•°æ®ä¼ é€’ç»™ç¼–ç å™¨è¿›è¡Œå‹ç¼©ï¼Œå¹¶å°†ç¼–ç åçš„æ•°æ®å‘é€ç»™åç»­çš„æ•°æ®ä¼ è¾“æµç¨‹
}


int32_t AudioCodingModuleImpl::Encode
{
	é€šè¿‡ éŸ³é¢‘æ•°æ® æ¢ç®—å‡º RTPåŒ…çš„æ—¶é—´æˆ³ï¼Œrtp_timestamp
	è°ƒç”¨ AudioEncoder::EncodedInfo AudioEncoder::Encode è¿›è¡Œç¼–ç å¤„ç†
	{
		AudioEncoder::EncodedInfo AudioEncoderOpusImpl::EncodeImpl //TODO
	}
	å‘é€ç»™å›è°ƒå‡½æ•° packetization_callback_->SendData ï¼Œè¿›è¡Œä¸‹ä¸€æ­¥å¤„ç†
}


int32_t ChannelSend::SendData
{
	è°ƒç”¨ SendRtpAudio() å‘é€éŸ³é¢‘æ•°æ®
}


int32_t ChannelSend::SendRtpAudio
{
	åœ¨RTPæ‰©å±•å¤´ä¸­è®¾ç½®audioLevel
	å¦‚æœæœ‰åŠ å¯†å™¨ï¼Œå°±å¯¹éŸ³é¢‘è¿›è¡ŒåŠ å¯†ï¼ˆé»˜è®¤æƒ…å†µä¸‹WebRTCæ²¡è¿›è¡ŒåŠ å¯†ï¼‰
	è°ƒç”¨ ModuleRtpRtcpImpl2::OnSendingRtpFrame åˆ¤æ–­æ˜¯å¦å¯ä»¥å‘é€éŸ³é¢‘ä»¥åŠRTCPæ”¶é›†ä¸€äº›ä¿¡æ¯
	å†è°ƒç”¨ RTPSenderAudio::SendAudio æŠŠæ•°æ®å‘é€åˆ°RTPéŸ³é¢‘å‘é€å™¨æ¨¡å—
}

bool RTPSenderAudio::SendAudio
{
	åˆ¤æ–­æ˜¯å¦å¼€å¯DTMFï¼Œè¿›è¡Œä¸€äº›åˆ—ç‰¹æ®Šå¤„ç†ï¼ˆWebRTCé»˜è®¤ä¸èµ°æ­¤é€»è¾‘ï¼‰
	æ„å»ºå‡º RtpPacketToSend å¯¹è±¡ï¼Œå¹¶ä¸”å¯¹packeté…ç½®æ‰€æœ‰éœ€è¦çš„æ•°æ®ï¼Œæ¯”å¦‚PayloadTypeã€TimeStampã€payloadDataâ€¦
	è°ƒç”¨ RTPSender::SendToNetwork å°†æ•°æ®ç»§ç»­æŠ•é€’
}


bool RTPSender::SendToNetwork
{
	ä¼šè°ƒç”¨ paced_sender_->EnqueuePackets(std::move(packets)) å°†éŸ³é¢‘æ•°æ®å‹å…¥é˜Ÿåˆ—ä¸­
	RTPå‘é€å™¨ä¼šæ ¹æ®ç½‘ç»œå¸¦å®½å’Œæ‹¥å¡æƒ…å†µè¿›è¡Œå‘é€é€Ÿç‡çš„æ§åˆ¶ï¼Œä»¥å¹³æ»‘çš„å‘é€æ•°æ®
}


class RtpPacketSenderProxy
void EnqueuePackets
{
	è°ƒç”¨ rtp_packet_pacer_->EnqueuePackets å°†æ•°æ®å‹å…¥é˜Ÿåˆ—ä¸­
}


void TaskQueuePacedSender::EnqueuePackets
{
	åˆ›å»ºä¸€ä¸ªBlockï¼Œå°†Blockæ”¾å…¥ rtc::TaskQueue task_queue_ é˜Ÿåˆ—ä¸­ï¼Œå¾…æ‰§è¡Œã€‚
	//TODO è¿™ä¸ªtask_queue_ ä»€ä¹ˆæ—¶å€™ä¼šè¢«æ‰§è¡Œå‘¢ï¼Ÿæ˜¯å¦è¿›è¡Œäº†é€Ÿç‡æ§åˆ¶ï¼Ÿ
	Blockæ‰§è¡Œæ—¶ï¼Œè°ƒç”¨ pacing_controller_.EnqueuePacket(std::move(packet)); è¿›è¡Œå°†ä»»åŠ¡å‹å…¥é˜Ÿåˆ—
}

void PacingController::EnqueuePacket
{
	è°ƒç”¨ BitrateProber::OnIncomingPacket ä½¿ç”¨åŒ…çš„æœ‰æ•ˆè´Ÿè½½å¤§å°é€šçŸ¥æ‹¥å¡æ§åˆ¶å™¨ï¼Œä»¥ä¾¿è¿›è¡Œæ‹¥å¡æ§åˆ¶ã€‚
	è°ƒç”¨ PrioritizedPacketQueue::Push å°†æ•°æ®åŒ…å‹å…¥é˜Ÿåˆ—ä¸­
}

void PrioritizedPacketQueue::Push
{
	æ ¹æ®ä¼˜å…ˆçº§è¿›è¡Œæ’åº
	åŒæ—¶è¿˜åŒ…æ‹¬äº†å¯¹é˜Ÿåˆ—å¤§å°ã€åœç•™æ—¶é—´å’Œå®šæœŸæ¸…ç†çš„ç»Ÿè®¡å’Œç®¡ç†ã€‚
	ç„¶åæŠŠ RtpPacketToSend è½¬æ¢æˆ QueuedPacketï¼Œå¹¶ä¸”æºå¸¦ä¸€äº›æ§åˆ¶é…ç½®
	æœ€åè°ƒç”¨ stream_queue->EnqueuePacket å°† QueuedPacket æ’å…¥åˆ°é˜Ÿåˆ—ä¸­
}
```



### 5ã€æœ¬åœ°éŸ³é¢‘æµè½¬çº¿è·¯ï¼ˆå‘é€ï¼‰<font color="red">ã€importantã€‘</font>ï¼Ÿ

// TODO è¿˜éœ€è¦çœ‹ä¸‹RTPå’ŒDTLSæ˜¯å¦‚ä½•å¯¹å®ƒä»¬è¿›è¡Œå¤„ç†çš„ï¼Ÿ

```c
void PacingController::ProcessPackets
{
	è°ƒç”¨ GetPendingPacket è·å– RtpPacketToSend å¯¹è±¡ï¼Œæœ€ç»ˆè°ƒç”¨ std::unique_ptr<RtpPacketToSend> PrioritizedPacketQueue::Pop è·å–
	è°ƒç”¨ void PacketRouter::SendPacket å°†
}

void PacketRouter::SendPacket
{
	è®¾ç½®éŸ³é¢‘æ•°æ®åŒ…çš„sequenceNumber
	é€šè¿‡éŸ³é¢‘æ•°æ®åŒ…çš„ ssrc è·å– rtp_module
	é€šè¿‡rtp_module çš„ ModuleRtpRtcpImpl2::TrySendPacket  å°è¯•å‘é€æ•°æ®åŒ…
	æœ€åå¦‚æœå¼€å¯FECï¼Œè¿˜è¦æŠŠæ•°æ®ç»™åˆ°FECæ¨¡å—
}

bool ModuleRtpRtcpImpl2::TrySendPacket
{
	è¿›è¡Œä¸€äº›å‚æ•°åˆ¤æ–­
	è°ƒç”¨ RtpSenderEgress::SendPacket è¿›è¡Œæ•°æ®å‘é€
}


void RtpSenderEgress::SendPacket 
{
	å¯¹packetçš„extensionè¿›è¡Œä¸€äº›è®¾ç½®
	è°ƒç”¨ AddPacketToTransportFeedback å°†åŒ…çš„ä¸€äº›æ•°æ®ç»™åˆ°feedbackæ¨¡å—
	è°ƒç”¨ SendPacketToNetwork è¿›è¡ŒåŒ…çš„å‘å¸ƒ
	å¦‚æœå‘å¸ƒæˆåŠŸï¼Œåšä¸€äº›æ ‡è®°
}

bool RtpSenderEgress::SendPacketToNetwork
{
	è°ƒç”¨ WebRtcVoiceMediaChannel::SendRtp çš„æ–¹æ³•è¿›è¡Œå‘é€
}

void MediaChannel::SendRtp
{
	å°è£…ä¸€ä¸ªBlockï¼Œå°†Blockæ‰”åˆ° network_thread_->PostTask é˜Ÿåˆ—ä¸­è°ƒç”¨
	
	è°ƒç”¨ MediaChannel::SendPacket ç»§ç»­å‘é€
}

bool MediaChannel::SendPacket 
{
	è°ƒç”¨ BaseChannel::SendPacket ç»§ç»­å‘é€æ•°æ®
}


bool BaseChannel::SendPacket 
{
	è°ƒç”¨ bool SrtpTransport::SendRtpPacket ç»§ç»­å‘é€
}

bool SrtpTransport::SendRtpPacket  
{
	è°ƒç”¨ bool RtpTransport::SendPacket ç»§ç»­å‘é€
}

bool RtpTransport::SendPacket
{
	è°ƒç”¨ int DtlsTransport::SendPacket ç»§ç»­å‘é€
}


int DtlsTransport::SendPacket
{
	é¦–å…ˆä¼šä¿è¯ DTLSå¤„äº webrtc::DtlsTransportState::kConnected çŠ¶æ€
	ç„¶åè°ƒç”¨ ice_transport_->SendPacket ç»§ç»­å‘é€
}

int P2PTransportChannel::SendPacket
{
	è°ƒç”¨ selected_connection_->Send ç»§ç»­å‘é€æ•°æ®
}

int ProxyConnection::Send
{
	è°ƒç”¨ int TurnPort::SendTo ç»§ç»­æ•°æ®å‘é€
}

int TurnPort::SendTo
{
	è°ƒç”¨ int TurnEntry::Send ç»§ç»­å‘é€
}

int TurnEntry::Send
{
	å°†éŸ³é¢‘åŒ…æ„å»ºæˆ ByteBufferWriter å’Œ TurnMessage ç»“æ„
	è°ƒç”¨ int TurnPort::Send ç»§ç»­å‘é€
}

int TurnPort::Send
{
	è°ƒç”¨ socket_->SendTo ç»§ç»­å‘é€
}

int AsyncUDPSocket::SendTo
{
	å°†æ•°æ®æ„å»ºæˆ rtc::SentPacket æ•°æ®ç»“æ„
	è°ƒç”¨ socket_->SendTo ç»§ç»­å‘é€
}

int PhysicalSocket::SendTo
{
	è°ƒç”¨ DoSendTo ç»§ç»­å‘é€
}

int PhysicalSocket::DoSendTo
{
	è°ƒç”¨ ::sendto(socket, buf, len, flags, dest_addr, addrlen) ç»§ç»­å‘é€ï¼Œè¿™æ¬¡çœŸçš„å‘é€å‡ºå»äº†ï¼Œå¤ªé•¿äº†å§ã€‚
}

```





### 6ã€ä¸è®©WebRTCçš„SDKåœ¨Debugæ¨¡å¼ä¸‹ï¼Œè‡ªåŠ¨è¾“å‡ºæ—¥å¿—è¦æ€ä¹ˆåšï¼Ÿ

```c
// logging.cc æ–‡ä»¶ä¸‹ä¿®æ”¹

#if !defined(NDEBUG)
constexpr LoggingSeverity kDefaultLoggingSeverity = LS_NONE;
#else
constexpr LoggingSeverity kDefaultLoggingSeverity = LS_NONE;
#endif
```



### 
